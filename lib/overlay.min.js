/*!
 * ffxiv-overlay-api v1.0.4 - MIT License
 * Copyright (c) 2020 DSRKafuU <amzrk2.cc>
 * Copyright (c) 2014 RainbowMage, hibiyasleep, ngld
 */

!function(s,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(s="undefined"!=typeof globalThis?globalThis:s||self).OverlayAPI=e()}(this,(function(){"use strict";var s={info(){for(var s=arguments.length,e=new Array(s),r=0;r<s;r++)e[r]=arguments[r];console.info("[OverlayAPI]",...e)},error(){for(var s=arguments.length,e=new Array(s),r=0;r<s;r++)e[r]=arguments[r];console.error("[OverlayAPI]",...e)}},e=["CombatData","LogLine","ImportedLogLines","ChangeZone","ChangePrimaryPlayer","OnlineStatusChanged"];return class extends class{constructor(){this._queue=[],this._status=!1,this.subscribers={},this._wsURL=/[?&]OVERLAY_WS=([^&]+)/.exec(window.location.href),this._wsURL?(this._ws=null,this._resPromises={},this.initWS()):this.initAPI()}initAPI(){if(window.OverlayPluginApi&&window.OverlayPluginApi.ready)for(this._status=!0,window.__OverlayCallback=this.triggerEvents.bind(this);this._queue.length>0;){var{msg:e,cb:r}=this._queue.shift();try{window.OverlayPluginApi.callHandler(JSON.stringify(e),r)}catch(r){s.error("Error stringify JSON",r,e)}}else setTimeout(this.initAPI,200)}initWS(){this._ws=new WebSocket(this._wsURL[1]),this._ws.addEventListener("error",e=>{s.error("WebSocket error",e)}),this._ws.addEventListener("open",()=>{for(s.info("WebSocket connected"),this._status=!0;this._queue.length>0;){var e=this._queue.shift();this.sendMessage(e)}}),this._ws.addEventListener("message",e=>{try{e=JSON.parse(e.data)}catch(r){return void s.error("Error stringify JSON",r,e)}void 0!==e.rseq&&this._resPromises[e.rseq]?(this._resPromises[e.rseq](e),delete this._resPromises[e.rseq]):this.triggerEvents(e)}),this._ws.addEventListener("close",()=>{this._status=!1,s.info("WebSocket trying to reconnect..."),setTimeout(()=>{this.initWS()},200)})}sendMessage(e,r){if(this._wsURL)if(this._status)try{this._ws.send(JSON.stringify(e))}catch(r){return void s.error("Error stringify JSON",r,e)}else this._queue.push(e);else if(this._status)try{window.OverlayPluginApi.callHandler(JSON.stringify(e),r)}catch(r){return void s.error("Error stringify JSON",r,e)}else this._queue.push({msg:e,cb:r})}listenEvent(s){this.sendMessage({call:"subscribe",events:[s]})}triggerEvents(s){if(this.subscribers[s.type])for(var e of this.subscribers[s.type])e(s)}}{constructor(){var s=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};for(var r in super(),this._events=s,this._events)if(!e.includes(r)){var i=this._events[r];i&&this.add(r,i)}}add(r,i){if(!e.includes(r)){var t=this.subscribers.hasOwnProperty(r);if(t||(this.subscribers[r]=[]),"function"==typeof i)this.subscribers[r].push(i);else{if(!Array.isArray(i))return void s.error("add() wrong event callbacks",i);i.forEach(s=>{this.subscribers[r].push(s)})}t||this.listenEvent(r)}}remove(e,r){if(this.subscribers.hasOwnProperty(e))if("function"==typeof r){var i=this.subscribers[e].indexOf(r);i>=0&&this.subscribers[e].splice(i,1)}else{if("number"!=typeof r)return void s.error("remove() wrong params",r);(r=this.subscribers[e][r])&&this.subscribers[e].splice(r,1)}}removeAll(s){this.subscribers[s]&&this.subscribers[s].length>0&&(this.subscribers[s]=[])}list(s){return this.subscribers[s]?this.subscribers[s]:[]}call(e){return new Promise((r,i)=>{this.sendMessage(e,e=>{var t;try{t=null==e?null:JSON.parse(e)}catch(r){return s.error("Error parse JSON",r,e),i(r)}return r(t)})})}}}));
