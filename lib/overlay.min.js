/*!
 * ffxiv-overlay-api v1.0.4 - MIT License
 * Copyright (c) 2020 DSRKafuU <amzrk2.cc>
 * Copyright (c) 2014 RainbowMage, hibiyasleep, ngld
 */

!function(s,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(s="undefined"!=typeof globalThis?globalThis:s||self).OverlayAPI=e()}(this,(function(){"use strict";var s={i(s){for(var e=arguments.length,t=new Array(e>1?e-1:0),i=1;i<e;i++)t[i-1]=arguments[i];console.info("[OverlayAPI]",s,...t)},e(s){for(var e=arguments.length,t=new Array(e>1?e-1:0),i=1;i<e;i++)t[i-1]=arguments[i];console.log("[OverlayAPI] Error occurred:",s,...t)}},e={CombatData:null,LogLine:null,ImportedLogLines:null,ChangeZone:null,ChangePrimaryPlayer:null,OnlineStatusChanged:null};return class extends class{constructor(){this._queue=[],this._status=!1,this.subscribers={},this._wsURL=/[?&]OVERLAY_WS=([^&]+)/.exec(window.location.href),this._wsURL?(this._ws=null,this._resPromises={},this.initWS()):this.initAPI()}initAPI(){if(window.OverlayPluginApi&&window.OverlayPluginApi.ready)for(this._status=!0,window.__OverlayCallback=this.triggerEvents.bind(this);this._queue.length>0;){var{msg:e,cb:t}=this._queue.shift();try{window.OverlayPluginApi.callHandler(JSON.stringify(e),t)}catch(t){s.e(t,e)}}else setTimeout(this.initAPI,200)}initWS(){this._ws=new WebSocket(this._wsURL[1]),this._ws.addEventListener("error",e=>{s.e(e)}),this._ws.addEventListener("open",()=>{for(s.i("WebSocket connected"),this._status=!0;this._queue.length>0;){var e=this._queue.shift();this.sendMessage(e)}}),this._ws.addEventListener("message",e=>{try{e=JSON.parse(e.data)}catch(t){return void s.e(t,e)}void 0!==e.rseq&&this._resPromises[e.rseq]?(this._resPromises[e.rseq](e),delete this._resPromises[e.rseq]):this.triggerEvents(e)}),this._ws.addEventListener("close",()=>{this._status=!1,s.i("WebSocket trying to reconnect..."),setTimeout(()=>{this.initWS()},200)})}sendMessage(e,t){if(this._wsURL)if(this._status)try{this._ws.send(JSON.stringify(e))}catch(t){return void s.e(t,e)}else this._queue.push(e);else if(this._status)try{window.OverlayPluginApi.callHandler(JSON.stringify(e),t)}catch(t){return void s.e(t,e)}else this._queue.push({msg:e,cb:t})}listenEvent(s){this.sendMessage({call:"subscribe",events:[s]})}triggerEvents(s){if(this.subscribers[s.type])for(var e of this.subscribers[s.type])e(s)}}{constructor(){var s=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};for(var t in super(),this._events=Object.assign({},e,s),this._events){var i=this._events[t];i&&this.add(t,i)}}add(e,t){var i=this.subscribers.hasOwnProperty(e);if(i||(this.subscribers[e]=[]),"function"==typeof t)this.subscribers[e].push(t);else{if(!Array.isArray(t))return void s.e("Wrong event callbacks",t);t.forEach(s=>{this.subscribers[e].push(s)})}i||this.listenEvent(e)}remove(e,t){var i;if(this.subscribers.hasOwnProperty(e))if("function"==typeof i){var r=this.subscribers[e].indexOf(i);r>=0&&this.subscribers[e].splice(r,1)}else{if("number"!=typeof i)return void s.e("Wrong params",i);(i=this.subscribers[e][i])&&this.subscribers[e].splice(i,1)}}removeAll(s){this.subscribers[s]&&this.subscribers[s].length>0&&(this.subscribers[s]=[])}list(s){return this.subscribers[s]?this.subscribers[s]:[]}call(e){return new Promise((t,i)=>{this.sendMessage(e,e=>{var r;try{r=null==e?null:JSON.parse(e)}catch(t){return s.e(t,e),i(t)}return t(r)})})}}}));
