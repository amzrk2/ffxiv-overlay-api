!function(e,s){"object"==typeof exports&&"undefined"!=typeof module?module.exports=s():"function"==typeof define&&define.amd?define(s):(e="undefined"!=typeof globalThis?globalThis:e||self).OverlayAPI=s()}(this,(function(){"use strict";class e{constructor(){this.queue=[],this.apiStatus=!1,this.subscribers={},this.wsURL=/[\?&]OVERLAY_WS=([^&]+)/.exec(window.location.href),this.wsURL?(this.ws=null,this.responsePromises={},this.initWS()):this.initAPI()}initAPI(){if(window.OverlayPluginApi&&window.OverlayPluginApi.ready)for(this.apiStatus=!0,window.__OverlayCallback=this.triggerEvent.bind(this);this.queue.length>0;){var{obj:e,cb:s}=this.queue.shift();window.OverlayPluginApi.callHandler(JSON.stringify(e),s)}else setTimeout(this.initAPI,200)}initWS(){this.ws=new WebSocket(this.wsURL[1]),this.ws.addEventListener("error",e=>{console.error(e)}),this.ws.addEventListener("open",()=>{for(console.info("[API] WebSocket connected"),this.apiStatus=!0;this.queue.length>0;){var e=this.queue.shift();this.sendMessage(e)}}),this.ws.addEventListener("message",e=>{try{e=JSON.parse(e.data)}catch(s){return void console.error("[API] WebSocket invalid message received: ",e,s)}void 0!==e.rseq&&this.responsePromises[e.rseq]?(this.responsePromises[e.rseq](e),delete this.responsePromises[e.rseq]):this.triggerEvent(e)}),this.ws.addEventListener("close",()=>{this.apiStatus=!1,console.info("[API] WebSocket trying to reconnect..."),setTimeout(()=>{this.initWS()},200)})}sendMessage(e,s){if(this.wsURL)if(this.apiStatus)try{this.ws.send(JSON.stringify(e))}catch(s){return void console.error("[API] Error stringfy message: ",e,s)}else this.queue.push(e);else if(this.apiStatus)try{window.OverlayPluginApi.callHandler(JSON.stringify(e),s)}catch(s){return void console.error("[API] Error stringfy message: ",e,s)}else this.queue.push({obj:e,cb:s})}triggerEvent(e){if(this.subscribers[e.type])for(var s of this.subscribers[e.type])s(e)}addOverlayListener(e,s){this.subscribers[e]||(this.subscribers[e]=[]),this.subscribers[e].push(s)}removeOverlayListener(e,s){if(this.subscribers[e]){var i=this.subscribers[e],t=i.indexOf(s);t>-1&&i.splice(t,1)}}startOverlayEvents(e){this.sendMessage({call:"subscribe",events:e})}callOverlayHandler(e){return new Promise((s,i)=>{this.sendMessage(e,e=>{try{null==e||JSON.parse(e)}catch(s){return console.error("[API] Error stringfy message: ",e,s),i(s)}return s(rd)})})}}var s={CombatData:null,LogLine:null,ImportedLogLines:null,ChangeZone:null,ChangePrimaryPlayer:null,OnlineStatusChanged:null};return class{constructor(){var i=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};for(var t in this.events=Object.assign({},s,i),this.listening={},this.api=new e,this.events){var r=this.events[t];r&&this.add(t,r)}}add(e,s){if("function"==typeof s)this.api.addOverlayListener(e,s),this.listening.hasOwnProperty(e)||(this.listening[e]=[],this.api.startOverlayEvents([e])),this.listening[e].push(s);else{if(!Array.isArray(s))return void console.error("[API] Wrong params:",s);s.forEach(s=>{this.api.addOverlayListener(e,s)}),this.listening.hasOwnProperty(e)||(this.listening[e]=[],this.api.startOverlayEvents([e])),this.listening[e].push(...s)}}remove(e,s){var i;if("function"==typeof s)i=s;else{if("number"!=typeof s)return void console.error("[API] Wrong params:",s);(i=this.listening[e][s])&&this.listening[e].splice(s,1)}i&&this.api.removeOverlayListener(e,i)}removeAll(e){this.listening[e]&&this.listening[e].length>0&&(this.listening[e].forEach(s=>{this.api.removeOverlayListener(e,s)}),this.listening[e]=[])}list(){console.log(this.listening)}call(e){return this.api.callOverlayHandler(e)}}}));
//# sourceMappingURL=overlay.min.js.map
