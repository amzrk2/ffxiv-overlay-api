{"version":3,"file":"index.esm.js","sources":["../src/components/log.js","../src/components/eventList.js","../src/components/plugin.js","../src/components/api.js"],"sourcesContent":["/**\r\n * Console logger\r\n */\r\nexport default {\r\n  info(...params) {\r\n    console.info('[OverlayAPI]', ...params);\r\n  },\r\n  error(...params) {\r\n    console.error('[OverlayAPI]', ...params);\r\n  },\r\n};\r\n","/**\r\n * All event types available\r\n */\r\nexport default [\r\n  'CombatData',\r\n  'LogLine',\r\n  'ImportedLogLines',\r\n  'ChangeZone',\r\n  'ChangePrimaryPlayer',\r\n  'OnlineStatusChanged',\r\n];\r\n","import log from './log';\r\n\r\n/**\r\n * Origin api ported from common.js\r\n * @class\r\n * @prop {String} _queue - Message queue before OverlayPluginApi is ready\r\n * @prop {Boolean} _status - OverlayPluginApi init status\r\n * @prop {String} _wsURL - Web Socket URL if exist\r\n * @prop {Object} _ws - Web Socket instance if exist\r\n * @prop {Object} subscribers - All subscribers for events emitted by OverlayPluginApi\r\n */\r\nexport default class PluginAPI {\r\n  /**\r\n   * Init API\r\n   * @constructor\r\n   */\r\n  constructor() {\r\n    this._queue = []; // { msg, cb } | msg\r\n    this._status = false;\r\n    this.subscribers = {}; // { eventName: [callbackFunc] }\r\n    // Check if in WebSocket mode\r\n    this._wsURL = /[?&]OVERLAY_WS=([^&]+)/.exec(window.location.href);\r\n    if (this._wsURL) {\r\n      this._ws = null;\r\n      this.initWS();\r\n    } else {\r\n      this.initAPI();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Init OverlayPluginApi connection\r\n   */\r\n  initAPI() {\r\n    if (!window.OverlayPluginApi || !window.OverlayPluginApi.ready) {\r\n      setTimeout(this.initAPI, 200);\r\n      return;\r\n    }\r\n    // API loaded\r\n    this._status = true;\r\n    // Bind `this` for callback function called by OverlayAPI, otherwist it will turn to `undefined`\r\n    window.__OverlayCallback = this.triggerEvents.bind(this);\r\n    // Send all messages in queue to OverlayPluginApi\r\n    while (this._queue.length > 0) {\r\n      let { msg, cb } = this._queue.shift();\r\n      try {\r\n        window.OverlayPluginApi.callHandler(JSON.stringify(msg), cb);\r\n      } catch (e) {\r\n        log.error('Error stringify JSON', e, msg);\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Init WebSocket connection\r\n   */\r\n  initWS() {\r\n    this._ws = new WebSocket(this._wsURL[1]);\r\n    // Log error\r\n    this._ws.addEventListener('error', (e) => {\r\n      log.error('WebSocket error', e);\r\n    });\r\n    // Successfully connected WebSocket\r\n    this._ws.addEventListener('open', () => {\r\n      log.info('WebSocket connected');\r\n      this._status = true;\r\n      while (this._queue.length > 0) {\r\n        let msg = this._queue.shift();\r\n        this.sendMessage(msg);\r\n      }\r\n    });\r\n    // On message loaded from WebSocket\r\n    this._ws.addEventListener('message', (msg) => {\r\n      try {\r\n        msg = JSON.parse(msg.data);\r\n      } catch (e) {\r\n        log.error('Error stringify JSON', e, msg);\r\n        return;\r\n      }\r\n      this.triggerEvents(msg);\r\n    });\r\n    // Connection failed\r\n    this._ws.addEventListener('close', () => {\r\n      this._status = false;\r\n      log.info('WebSocket trying to reconnect...');\r\n      // Don't spam the server with retries\r\n      setTimeout(() => {\r\n        this.initWS();\r\n      }, 200);\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Send message to OverlayPluginApi or push into queue before its init\r\n   * @param {Object} msg - Object to send\r\n   * @param {Function} cb - Callback function\r\n   */\r\n  sendMessage(msg, cb) {\r\n    if (this._wsURL) {\r\n      if (this._status) {\r\n        try {\r\n          this._ws.send(JSON.stringify(msg));\r\n        } catch (e) {\r\n          log.error('Error stringify JSON', e, msg);\r\n          return;\r\n        }\r\n      } else {\r\n        this._queue.push(msg);\r\n      }\r\n    } else {\r\n      if (this._status) {\r\n        try {\r\n          window.OverlayPluginApi.callHandler(JSON.stringify(msg), cb);\r\n        } catch (e) {\r\n          log.error('Error stringify JSON', e, msg);\r\n          return;\r\n        }\r\n      } else {\r\n        this._queue.push({ msg, cb });\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Start listening event\r\n   * @param {String} event - Event which to subscribe\r\n   */\r\n  listenEvent(event) {\r\n    this.sendMessage({\r\n      call: 'subscribe',\r\n      events: [event],\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Trigger event function, called by OverlayPluginApi, need `this` binding\r\n   * @param {Object} msg - Data from OverlayPluginApi\r\n   */\r\n  triggerEvents(msg) {\r\n    // If this event type has subscribers\r\n    if (this.subscribers[msg.type]) {\r\n      // Trigger all event's callback\r\n      for (let cb of this.subscribers[msg.type]) {\r\n        cb(msg);\r\n      }\r\n    }\r\n  }\r\n}\r\n","import log from './log';\r\nimport eventList from './eventList';\r\nimport PluginAPI from './plugin';\r\n\r\n/**\r\n * Public API class\r\n * @class\r\n * @extends PluginAPI\r\n * @prop {String} _events - Events needs to be init at construct\r\n * @extends @prop {Object} subscribers - All subscribers for events emitted by OverlayPluginApi\r\n */\r\nexport default class OverlayAPI extends PluginAPI {\r\n  /**\r\n   * Init API\r\n   * @constructor\r\n   * @param {Object} events - Events needs to be init at construct\r\n   */\r\n  constructor(events = {}) {\r\n    super();\r\n    this._events = events;\r\n    // Register all events\r\n    for (let event in this._events) {\r\n      if (eventList.includes(event)) {\r\n        let cbs = this._events[event];\r\n        if (cbs) {\r\n          this.add(event, cbs);\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Add an event listener\r\n   * @param {String} event - Event to listen\r\n   * @param {Function|Array} cbs - Callback function(s)\r\n   */\r\n  add(event, cbs) {\r\n    if (eventList.includes(event)) {\r\n      const eventListened = this.subscribers.hasOwnProperty(event);\r\n      // Init event array\r\n      if (!eventListened) {\r\n        this.subscribers[event] = [];\r\n      }\r\n      // Push events\r\n      if (typeof cbs === 'function') {\r\n        this.subscribers[event].push(cbs);\r\n      } else if (Array.isArray(cbs)) {\r\n        cbs.forEach((f) => {\r\n          this.subscribers[event].push(f);\r\n        });\r\n      } else {\r\n        log.error('Function add(event, cbs) wrong event callbacks', cbs);\r\n        return;\r\n      }\r\n      // Listen event type\r\n      if (!eventListened) {\r\n        this.listenEvent(event);\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Remove a listener\r\n   * @param {String} event - Event type which listener belongs to\r\n   * @param {Function|Number} cb - Function or number which listener to remove\r\n   */\r\n  remove(event, cb) {\r\n    const eventListened = this.subscribers.hasOwnProperty(event);\r\n    if (eventListened) {\r\n      if (typeof cb === 'function') {\r\n        let cbPos = this.subscribers[event].indexOf(cb);\r\n        if (cbPos >= 0) {\r\n          this.subscribers[event].splice(cbPos, 1);\r\n        }\r\n      } else if (typeof cb === 'number') {\r\n        cb = this.subscribers[event][cb];\r\n        if (cb) {\r\n          this.subscribers[event].splice(cb, 1);\r\n        }\r\n      } else {\r\n        log.error('Function remove(event, cb) wrong params', cb);\r\n        return;\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Remove all listener of one event type\r\n   * @param {String} event - Event type which listener belongs to\r\n   */\r\n  removeAll(event) {\r\n    if (this.subscribers[event] && this.subscribers[event].length > 0) {\r\n      this.subscribers[event] = [];\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get all listeners of a event\r\n   * @param {String} event - Event type which listener belongs to\r\n   */\r\n  list(event) {\r\n    return this.subscribers[event] ? this.subscribers[event] : [];\r\n  }\r\n\r\n  /**\r\n   * This function allows you to call an overlay handler.\r\n   * These handlers are declared by Event Sources (either built into OverlayPlugin or loaded through addons like Cactbot).\r\n   * Returns a Promise\r\n   * @param {Object} msg - Message send to OverlayPlugin\r\n   */\r\n  call(msg) {\r\n    return new Promise((resolve, reject) => {\r\n      this.sendMessage(msg, (data) => {\r\n        let rd;\r\n        try {\r\n          rd = data == null ? null : JSON.parse(data);\r\n        } catch (e) {\r\n          log.error('Error parse JSON', e, data);\r\n          return reject(e);\r\n        }\r\n        return resolve(rd);\r\n      });\r\n    });\r\n  }\r\n}\r\n"],"names":["info","params","console","error","PluginAPI","constructor","_queue","_status","subscribers","_wsURL","exec","window","location","href","_ws","initWS","initAPI","OverlayPluginApi","ready","setTimeout","__OverlayCallback","triggerEvents","bind","length","msg","cb","shift","callHandler","JSON","stringify","e","log","WebSocket","addEventListener","sendMessage","parse","data","send","push","listenEvent","event","call","events","type","OverlayAPI","_events","eventList","includes","cbs","add","eventListened","hasOwnProperty","Array","isArray","forEach","f","remove","cbPos","indexOf","splice","removeAll","list","Promise","resolve","reject","rd"],"mappings":"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"}