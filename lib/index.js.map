{"version":3,"file":"index.js","sources":["../src/components/events.js","../src/components/plugin.js","../src/components/api.js"],"sourcesContent":["export default {\r\n  CombatData: null,\r\n  LogLine: null,\r\n  ImportedLogLines: null,\r\n  ChangeZone: null,\r\n  ChangePrimaryPlayer: null,\r\n  OnlineStatusChanged: null,\r\n};\r\n","/**\r\n * Origin api ported from common.js\r\n * @class\r\n * @param {Function} initWS\r\n * @param {Function} initAPI\r\n * @param {Function} sendMessage\r\n * @param {Function} triggerEvents\r\n */\r\n\r\nexport default class API {\r\n  /**\r\n   * Init API\r\n   * @constructor\r\n   * @param {String} queue - Message queue before OverlayPluginApi is ready\r\n   * @param {Boolean} apiStatus - OverlayPluginApi init status\r\n   * @param {Object} subscribers - All subscribers for events emitted by OverlayPluginApi\r\n   */\r\n  constructor() {\r\n    this.queue = [];\r\n    this.apiStatus = false;\r\n    this.subscribers = {}; // { eventName: [callbackFunc] }\r\n    // Check if in WebSocket mode\r\n    this.wsURL = /[?&]OVERLAY_WS=([^&]+)/.exec(window.location.href);\r\n    if (this.wsURL) {\r\n      this.ws = null;\r\n      this.responsePromises = {};\r\n      this.initWS();\r\n    } else {\r\n      this.initAPI();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Init OverlayPluginApi connection\r\n   */\r\n  initAPI() {\r\n    if (!window.OverlayPluginApi || !window.OverlayPluginApi.ready) {\r\n      setTimeout(this.initAPI, 200);\r\n      return;\r\n    }\r\n    // API loaded\r\n    this.apiStatus = true;\r\n    // Bind `this` for callback function called by OverlayAPI, otherwist it will turn to `undefined`\r\n    window.__OverlayCallback = this.triggerEvents.bind(this);\r\n    // Send all messages in queue to OverlayPluginApi\r\n    while (this.queue.length > 0) {\r\n      let { obj, cb } = this.queue.shift();\r\n      window.OverlayPluginApi.callHandler(JSON.stringify(obj), cb);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Init WebSocket connection\r\n   */\r\n  initWS() {\r\n    this.ws = new WebSocket(this.wsURL[1]);\r\n    // Log error\r\n    this.ws.addEventListener('error', (e) => {\r\n      console.error(e);\r\n    });\r\n    // Successfully connected WebSocket\r\n    this.ws.addEventListener('open', () => {\r\n      console.info('[API] WebSocket connected');\r\n      this.apiStatus = true;\r\n      while (this.queue.length > 0) {\r\n        let msg = this.queue.shift();\r\n        this.sendMessage(msg);\r\n      }\r\n    });\r\n    // On message loaded from WebSocket\r\n    this.ws.addEventListener('message', (msg) => {\r\n      try {\r\n        msg = JSON.parse(msg.data);\r\n      } catch (e) {\r\n        console.error('[API] WebSocket invalid message received: ', msg, e);\r\n        return;\r\n      }\r\n      if (msg.rseq !== undefined && this.responsePromises[msg.rseq]) {\r\n        this.responsePromises[msg.rseq](msg);\r\n        delete this.responsePromises[msg.rseq];\r\n      } else {\r\n        this.triggerEvents(msg);\r\n      }\r\n    });\r\n    // Connection failed\r\n    this.ws.addEventListener('close', () => {\r\n      this.apiStatus = false;\r\n      console.info('[API] WebSocket trying to reconnect...');\r\n      // Don't spam the server with retries\r\n      setTimeout(() => {\r\n        this.initWS();\r\n      }, 200);\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Send message to OverlayPluginApi or push into queue before its init\r\n   * @param {Object} obj - Object to send\r\n   * @param {Function} cb - Callback function\r\n   */\r\n  sendMessage(obj, cb) {\r\n    if (this.wsURL) {\r\n      if (this.apiStatus) {\r\n        try {\r\n          this.ws.send(JSON.stringify(obj));\r\n        } catch (e) {\r\n          console.error('[API] Error stringfy message: ', obj, e);\r\n          return;\r\n        }\r\n      } else {\r\n        this.queue.push(obj);\r\n      }\r\n    } else {\r\n      if (this.apiStatus) {\r\n        try {\r\n          window.OverlayPluginApi.callHandler(JSON.stringify(obj), cb);\r\n        } catch (e) {\r\n          console.error('[API] Error stringfy message: ', obj, e);\r\n          return;\r\n        }\r\n      } else {\r\n        this.queue.push({ obj, cb });\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Trigger event function, called by OverlayPluginApi, need `this` binding\r\n   * @param {Object} msg - Data from OverlayPluginApi\r\n   */\r\n  triggerEvents(msg) {\r\n    // If this event type has subscribers\r\n    if (this.subscribers[msg.type]) {\r\n      // Trigger all event's callback\r\n      for (let cb of this.subscribers[msg.type]) {\r\n        cb(msg);\r\n      }\r\n    }\r\n  }\r\n}\r\n","import e from './events.js';\r\nimport API from './plugin.js';\r\n\r\n/**\r\n * Public API class\r\n * @class\r\n * @param {Function} listenEvents\r\n * @param {Function} add\r\n * @param {Function} remove\r\n * @param {Function} removeAll\r\n * @param {Function} list\r\n * @param {Function} call\r\n */\r\n\r\nexport default class OverlayAPI extends API {\r\n  /**\r\n   * Init API\r\n   * @constructor\r\n   * @extends API\r\n   * @param {Object} events - Events needs to be init at constructor\r\n   */\r\n  constructor(events = {}) {\r\n    super();\r\n    this.events = Object.assign({}, e, events);\r\n    // Register all events\r\n    for (let event in this.events) {\r\n      let cbs = this.events[event];\r\n      if (cbs) {\r\n        this.add(event, cbs);\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Start listening events\r\n   * @param {Array} events - Events which to subscribe\r\n   */\r\n  listenEvents(events) {\r\n    this.sendMessage({\r\n      call: 'subscribe',\r\n      events,\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Add an event listener\r\n   * @param {String} event - Event to listen\r\n   * @param {Function|Array} cbs - Callback function(s)\r\n   */\r\n  add(event, cbs) {\r\n    const eventListened = this.subscribers.hasOwnProperty(event);\r\n    // Init event array\r\n    if (!eventListened) {\r\n      this.subscribers[event] = [];\r\n    }\r\n    // Push events\r\n    if (typeof cbs === 'function') {\r\n      this.subscribers[event].push(cbs);\r\n    } else if (Array.isArray(cbs)) {\r\n      cbs.forEach((f) => {\r\n        this.subscribers[event].push(f);\r\n      });\r\n    } else {\r\n      console.error('[API] Wrong params:', cbs);\r\n      return;\r\n    }\r\n    // Listen event type\r\n    if (!eventListened) {\r\n      this.listenEvents([event]);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Remove a listener\r\n   * @param {String} event - Event type which listener belongs to\r\n   * @param {Function|Number} id - Function or number which listener to remove\r\n   */\r\n  remove(event, id) {\r\n    const eventListened = this.subscribers.hasOwnProperty(event);\r\n    if (eventListened) {\r\n      // Get cb\r\n      let cb;\r\n      if (typeof id === 'function') {\r\n        let cbPos = this.subscribers[event].indexOf(id);\r\n        if (cbPos >= 0) {\r\n          this.subscribers[event].splice(pos, 1);\r\n        }\r\n      } else if (typeof id === 'number') {\r\n        cb = this.subscribers[event][id];\r\n        if (cb) {\r\n          this.subscribers[event].splice(id, 1);\r\n        }\r\n      } else {\r\n        console.error('[API] Wrong params:', id);\r\n        return;\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Remove all listener of one event type\r\n   * @param {String} event - Event type which listener belongs to\r\n   */\r\n  removeAll(event) {\r\n    if (this.subscribers[event] && this.subscribers[event].length > 0) {\r\n      this.subscribers[event] = [];\r\n    }\r\n  }\r\n\r\n  /**\r\n   * List all event listeners\r\n   */\r\n  list() {\r\n    console.log(this.subscribers);\r\n  }\r\n\r\n  /**\r\n   * This function allows you to call an overlay handler.\r\n   * These handlers are declared by Event Sources (either built into OverlayPlugin or loaded through addons like Cactbot).\r\n   * Returns a Promise\r\n   * @param {Object} msg - Message send to OverlayPlugin\r\n   */\r\n  call(msg) {\r\n    return new Promise((resolve, reject) => {\r\n      this.sendMessage(msg, (data) => {\r\n        let rd;\r\n        try {\r\n          rd = data == null ? null : JSON.parse(data);\r\n        } catch (e) {\r\n          console.error('[API] Error stringfy message: ', data, e);\r\n          return reject(e);\r\n        }\r\n        return resolve(rd);\r\n      });\r\n    });\r\n  }\r\n}\r\n"],"names":["CombatData","LogLine","ImportedLogLines","ChangeZone","ChangePrimaryPlayer","OnlineStatusChanged","API","constructor","queue","apiStatus","subscribers","wsURL","exec","window","location","href","ws","responsePromises","initWS","initAPI","OverlayPluginApi","ready","setTimeout","__OverlayCallback","triggerEvents","bind","length","obj","cb","shift","callHandler","JSON","stringify","WebSocket","addEventListener","e","console","error","info","msg","sendMessage","parse","data","rseq","undefined","send","push","type","OverlayAPI","events","Object","assign","event","cbs","add","listenEvents","call","eventListened","hasOwnProperty","Array","isArray","forEach","f","remove","id","cbPos","indexOf","splice","pos","removeAll","list","log","Promise","resolve","reject","rd"],"mappings":"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"}